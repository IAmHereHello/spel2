<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Math: Driehoeken Jacht</title>
    <style>
        body {
            margin: 0;
            background-color: #222;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        /* CANVAS */
        canvas {
            background: #111;
            border: 4px solid #4ecca3;
            box-shadow: 0 0 20px rgba(78, 204, 163, 0.2);
            border-radius: 4px;
            width: 100%;
            flex-grow: 1;
            max-height: 55vh;
            /* Slightly smaller to fit 3 buttons nicely */
            display: block;
        }

        /* CONTROLS */
        #controls-wrapper {
            width: 100%;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Ammo Buttons */
        #ammo-controls {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
        }

        .ammo-btn {
            flex: 1;
            height: 70px;
            background: #1a1a2e;
            border: 2px solid #555;
            border-radius: 8px;
            color: #ccc;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            /* Stack Icon and Text */
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .ammo-btn span {
            font-size: 10px;
            opacity: 0.7;
        }

        .ammo-btn.active {
            border-color: white;
            color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* MOVES */
        #touch-moves {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .move-btn {
            width: 80px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
        }

        .fire-btn {
            width: 100px;
            height: 60px;
            background: rgba(241, 196, 15, 0.2);
            border: 2px solid #f1c40f;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
        }

        .move-btn:active,
        .fire-btn:active {
            opacity: 0.7;
            transform: scale(0.95);
        }

        /* Overlays */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 25, 0.95);
            padding: 30px;
            border: 2px solid #4ecca3;
            border-radius: 12px;
            text-align: center;
            width: 80%;
            max-width: 400px;
            z-index: 100;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }

        h1 {
            margin-top: 0;
            color: #4ecca3;
            font-size: 24px;
        }

        p {
            color: #ccc;
            margin: 15px 0;
        }

        input {
            width: 90%;
            padding: 10px;
            background: #222;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button.ui-btn {
            background: #1a1a2e;
            color: #4ecca3;
            border: 2px solid #4ecca3;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .unlock-code {
            font-family: monospace;
            font-size: 32px;
            color: #f1c40f;
            border: 2px dashed #f1c40f;
            padding: 10px;
            background: #222;
            margin: 20px 0;
            letter-spacing: 2px;
        }

        .hidden {
            display: none !important;
        }

        .mini-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
            display: inline-block;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="600"></canvas>

        <div id="controls-wrapper">

            <div id="ammo-controls">
                <!-- 0: Blue (Recht) -->
                <div class="ammo-btn active" id="btn-0" style="border-color:#3498db" onclick="selectAmmo(0)">
                    <svg class="mini-icon" viewBox="0 0 20 20">
                        <path d="M5,5 L5,15 L15,15" fill="none" stroke="#3498db" stroke-width="2" />
                    </svg>
                    RECHT
                </div>
                <!-- 1: Red (Stomp) -->
                <div class="ammo-btn" id="btn-1" style="border-color:#e74c3c" onclick="selectAmmo(1)">
                    <svg class="mini-icon" viewBox="0 0 20 20">
                        <path d="M2,5 L10,15 L18,5" fill="none" stroke="#e74c3c" stroke-width="2" />
                    </svg>
                    STOMP
                </div>
                <!-- 2: Green (Scherp) -->
                <div class="ammo-btn" id="btn-2" style="border-color:#2ecc71" onclick="selectAmmo(2)">
                    <svg class="mini-icon" viewBox="0 0 20 20">
                        <path d="M2,15 L10,2 L18,15 Z" fill="none" stroke="#2ecc71" stroke-width="2" />
                    </svg>
                    SCHERP
                </div>
            </div>

            <div id="touch-moves">
                <div class="move-btn" id="btn-left">⬅️</div>
                <div class="fire-btn" id="btn-shoot">FIRE</div>
                <div class="move-btn" id="btn-right">➡️</div>
            </div>
        </div>

        <!-- SCREENS -->
        <div id="screen-login" class="overlay">
            <h1>Missie: Driehoeken Jacht</h1>
            <p>Identificatie Vereist</p>
            <input type="password" id="inp-code" placeholder="Code (DELTA180)">
            <input type="text" id="inp-name" placeholder="Jouw Codenaam">
            <button class="ui-btn" onclick="submitLogin()">Start Missie</button>
        </div>

        <div id="screen-gameover" class="overlay hidden" style="border-color: #ff4757;">
            <h1 style="color: #ff4757;">MISSIE MISLUKT</h1>
            <p>Score: <span id="score-loss">0</span></p>
            <button class="ui-btn" onclick="location.reload()">Opnieuw Proberen</button>
        </div>

        <div id="screen-win" class="overlay hidden" style="border-color: #f1c40f;">
            <h1 style="color: #f1c40f;">DOEL BEREIKT!</h1>
            <p>Je hebt 200 punten behaald.</p>
            <p>UNLOCK CODE:</p>
            <div class="unlock-code">PYTHAGORAS</div>
            <p style="font-size: 12px; color: #888;">Noteer deze code!</p>
        </div>
    </div>

    <script>
        /* ---------------- CONFIG ---------------- */
        const LOG_URL = "https://script.google.com/macros/s/AKfycbytukuFv4uakCSohLYXZa-44gzMv_0jWAAQoBfLXHaMTN_TsRYK0lcVaeKhkXtbdek7XA/exec";
        const TARGET_SCORE = 200;
        const BASE_SPAWN_INTERVAL = 2500;

        // Colors
        const AMMO = [
            { id: 0, label: "RECHT", color: "#3498db" },  // Blue
            { id: 1, label: "STOMP", color: "#e74c3c" },  // Red
            { id: 2, label: "SCHERP", color: "#2ecc71" }  // Green
        ];

        /* ---------------- STATE ---------------- */
        let playerName = "";
        let score = 0;
        let lives = 3;
        let gameRunning = false;
        let lastTime = 0;
        let spawnTimer = 0;
        let selectedAmmo = 0; // 0, 1, 2

        let player = { x: 275, y: 530, w: 50, h: 50 };
        let bullets = [];
        let enemies = [];
        let stars = [];

        /* ---------------- INIT ---------------- */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Init Stars
        for (let i = 0; i < 80; i++) {
            stars.push({
                x: Math.random() * 600,
                y: Math.random() * 600,
                size: Math.random() * 2,
                speed: Math.random() * 1.5 + 0.5
            });
        }

        /* ---------------- CONTROLS ---------------- */
        const keys = { Left: false, Right: false };

        window.addEventListener('keydown', e => {
            if (e.code === 'ArrowLeft') keys.Left = true;
            if (e.code === 'ArrowRight') keys.Right = true;
            if (e.code === 'Space' && gameRunning) fireBullet();
            if (e.key === '1') selectAmmo(0);
            if (e.key === '2') selectAmmo(1);
            if (e.key === '3') selectAmmo(2);
        });

        window.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') keys.Left = false;
            if (e.code === 'ArrowRight') keys.Right = false;
        });

        function bindTouch(id, startFn, endFn) {
            const el = document.getElementById(id);
            const handleStart = (e) => { e.preventDefault(); startFn(); };
            const handleEnd = (e) => { e.preventDefault(); endFn(); };
            el.addEventListener('mousedown', handleStart);
            el.addEventListener('mouseup', handleEnd);
            el.addEventListener('touchstart', handleStart);
            el.addEventListener('touchend', handleEnd);
            el.addEventListener('mouseleave', handleEnd);
        }

        bindTouch('btn-left', () => keys.Left = true, () => keys.Left = false);
        bindTouch('btn-right', () => keys.Right = true, () => keys.Right = false);
        bindTouch('btn-shoot', () => fireBullet(), () => { });

        function selectAmmo(idx) {
            selectedAmmo = idx;
            // UI
            for (let i = 0; i < 3; i++) {
                const btn = document.getElementById(`btn-${i}`);
                if (i === idx) {
                    btn.classList.add('active');
                    btn.style.backgroundColor = AMMO[i].color;
                    btn.style.color = "black";
                } else {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = "#1a1a2e";
                    btn.style.color = AMMO[i].color;
                }
            }
        }
        // Initialize selection visual
        selectAmmo(0);

        /* ---------------- LOOPS ---------------- */
        function submitLogin() {
            const code = document.getElementById('inp-code').value.trim().toUpperCase();
            const name = document.getElementById('inp-name').value.trim();

            if (code !== "DELTA180") return alert("Code onjuist!");
            if (!name) return alert("Naam verplicht!");

            playerName = name;
            document.getElementById('screen-login').classList.add('hidden');
            startGame();
        }

        function startGame() {
            score = 0;
            lives = 3;
            player.x = 275;
            bullets = [];
            enemies = [];
            selectedAmmo = 0;
            selectAmmo(0);
            gameRunning = true;
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function fireBullet() {
            bullets.push({
                x: player.x + 25,
                y: player.y,
                type: selectedAmmo,
                color: AMMO[selectedAmmo].color
            });
            playSound(400, 'square');
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            update(dt);
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            // Player
            if (keys.Left) player.x -= 0.5 * dt;
            if (keys.Right) player.x += 0.5 * dt;
            if (player.x < 0) player.x = 0;
            if (player.x > 550) player.x = 550;

            // Bullets
            for (let i = 0; i < bullets.length; i++) {
                bullets[i].y -= 0.8 * dt;
                if (bullets[i].y < -20) { bullets.splice(i, 1); i--; }
            }

            // Spawn
            let currentInterval = Math.max(800, BASE_SPAWN_INTERVAL - (score * 8));
            spawnTimer += dt;
            if (spawnTimer > currentInterval) {
                spawnEnemy();
                spawnTimer = 0;
            }

            // Enemies
            for (let i = 0; i < enemies.length; i++) {
                let e = enemies[i];
                e.y += e.speed * (dt / 16);
                e.rotation += e.rotSpeed * (dt / 16);

                // Check Hits
                const hitDist = 45;
                let hit = false;
                for (let b = 0; b < bullets.length; b++) {
                    let bull = bullets[b];
                    const dist = Math.hypot(bull.x - e.x, bull.y - e.y);

                    if (dist < hitDist) {
                        if (bull.type === e.type) {
                            score += 10;
                            playSound(600, 'sine');
                            enemies.splice(i, 1); i--;
                            bullets.splice(b, 1); b--;
                            if (score >= TARGET_SCORE) doWin();
                            hit = true;
                        } else {
                            score -= 5;
                            if (score < 0) score = 0;
                            playSound(150, 'sawtooth');
                            bullets.splice(b, 1); b--;
                            hit = true;
                        }
                        break;
                    }
                }
                if (hit) continue;

                if (e.y > 600) {
                    lives--;
                    playSound(100, 'sawtooth');
                    enemies.splice(i, 1); i--;
                    if (lives <= 0) doGameOver();
                }
            }

            // Stars
            stars.forEach(s => {
                s.y += s.speed * (dt / 16);
                if (s.y > 600) { s.y = 0; s.x = Math.random() * 600; }
            });
        }

        function spawnEnemy() {
            const type = Math.floor(Math.random() * 3);
            const difficultyLevel = Math.floor(score / 30);
            const speedMultiplier = 1 + (difficultyLevel * 0.1);
            const speed = (0.4 + Math.random() * 0.3) * speedMultiplier;

            enemies.push({
                x: 50 + Math.random() * 500,
                y: -60,
                type: type,
                speed: speed,
                rotation: Math.random() * 360,
                rotSpeed: (Math.random() - 0.5) * 1.5,
                color: "#FFD700" // GOLD
            });
        }

        /* ---------------- DRAWING ---------------- */
        function pathShape(ctx, type, size) {
            ctx.beginPath();
            if (type === 0) { // Recht
                ctx.moveTo(-size / 2, -size / 2);
                ctx.lineTo(-size / 2, size / 2);
                ctx.lineTo(size / 2 + 10, size / 2);
                ctx.closePath();
            } else if (type === 1) { // Stomp
                ctx.moveTo(-size, -10);
                ctx.lineTo(0, 15);
                ctx.lineTo(size, -10);
                ctx.closePath();
            } else { // Scherp
                const h = size * (Math.sqrt(3) / 2);
                ctx.moveTo(0, -h / 2);
                ctx.lineTo(size / 2, h / 2);
                ctx.lineTo(-size / 2, h / 2);
                ctx.closePath();
            }
        }

        function draw() {
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, 600, 600);

            // Stars
            ctx.fillStyle = "white";
            ctx.globalAlpha = 0.6;
            stars.forEach(s => ctx.fillRect(s.x, s.y, s.size, s.size));
            ctx.globalAlpha = 1;

            // Enemies
            enemies.forEach(e => {
                ctx.save();
                ctx.translate(e.x, e.y);
                ctx.rotate(e.rotation * Math.PI / 180);

                ctx.strokeStyle = e.color;
                ctx.lineWidth = 4;
                ctx.lineJoin = "round";

                pathShape(ctx, e.type, 40);

                ctx.stroke();
                ctx.fillStyle = "rgba(255, 215, 0, 0.2)";
                ctx.fill();
                ctx.restore();
            });

            // Player
            const pColor = AMMO[selectedAmmo].color;
            ctx.fillStyle = pColor;
            ctx.beginPath();
            ctx.moveTo(player.x + 25, player.y);
            ctx.lineTo(player.x + 50, player.y + 50);
            ctx.lineTo(player.x + 25, player.y + 40);
            ctx.lineTo(player.x, player.y + 50);
            ctx.fill();

            // Bullets
            bullets.forEach(b => {
                ctx.fillStyle = b.color;
                ctx.fillRect(b.x - 4, b.y, 8, 16);
            });

            // Score Canvas Overlay
            ctx.fillStyle = "white";
            ctx.font = "bold 20px Segoe UI";
            ctx.textAlign = "left";
            ctx.fillText(`SCORE: ${score}`, 20, 40);
            ctx.textAlign = "right";
            ctx.fillText("❤️".repeat(lives), 580, 40);
        }

        /* ---------------- END ---------------- */
        function doWin() {
            gameRunning = false;
            logData(score);
            document.getElementById('screen-win').classList.remove('hidden');
        }

        function doGameOver() {
            gameRunning = false;
            logData(score);
            document.getElementById('score-loss').innerText = score;
            document.getElementById('screen-gameover').classList.remove('hidden');
        }

        function logData(finalScore) {
            const url = `${LOG_URL}?action=submit&code=${encodeURIComponent(playerName)}&quizId=Game2_Triangles&score=${finalScore}&total=${TARGET_SCORE}`;
            fetch(url, { mode: 'no-cors' }).catch(e => console.error(e));
        }

        /* ---------------- AUDIO ---------------- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }
    </script>
</body>

</html>
